<!DOCTYPE html>
<html>
<head>
<title>Admin</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h1>Admin Score Panel</h1>

<div id="adminMatches"></div>

<script src="supabase.js"></script>
<script>

async function initAdmin(){
  const { data: matches } = await supabaseClient
    .from("matches")
    .select("*")
    .order("round",{ascending:true})
    .order("match_number",{ascending:true});

  let html = "";
  matches.forEach(m=>{
    html += `
      <div>
        ${m.player1 || '-'}
        <input 
          type="number" 
          value="${m.score1}" 
          onchange="updateScore(${m.id},1,this.value)"
        >
        vs
        <input 
          type="number" 
          value="${m.score2}" 
          onchange="updateScore(${m.id},2,this.value)"
        >
        ${m.player2 || '-'}
      </div>
    `;
  });

  document.getElementById("adminMatches").innerHTML = html;
}

async function updateScore(id,player,val){
  const pkg = player===1 
    ? { score1: parseInt(val) }
    : { score2: parseInt(val) };

  await supabaseClient.from("matches")
    .update(pkg)
    .eq("id",id);

  checkWinner(id);
}

async function checkWinner(id){
  const { data } = await supabaseClient
    .from("matches")
    .select("*")
    .eq("id",id)
    .single();

  if(data.score1 >= data.race_to){
    await supabaseClient.from("matches").update({winner:data.player1}).eq("id",id);
    autoAdvance(data,data.player1);
  }
  if(data.score2 >= data.race_to){
    await supabaseClient.from("matches").update({winner:data.player2}).eq("id",id);
    autoAdvance(data,data.player2);
  }
}

async function autoAdvance(match,winner){
  const nextRound = match.round + 1;
  const nextMatchNum = Math.ceil(match.match_number/2);

  const { data } = await supabaseClient.from("matches")
    .select("*")
    .eq("round",nextRound)
    .eq("match_number",nextMatchNum)
    .single();

  if(data){
    const key = (match.match_number %2===1) 
      ? "player1" 
      : "player2";

    await supabaseClient.from("matches")
      .update({ [key]: winner })
      .eq("id", data.id);
  }
}

initAdmin();

</script>

</body>
</html>
